# ntm-orchestrator manifest
# Machine-readable skill metadata

id: ntm-orchestrator
name: "NTM Multi-Agent Orchestrator"
version: "1.1.0"
description: |
  Orchestrate parallel AI agent execution via ntm (Named Tmux Manager).
  Uses robot mode exclusively for automation stability.

# Dependencies
dependencies:
  required:
    - name: ntm
      purpose: "Multi-agent session management"
      install: "ACFS verified installer or brew install dicklesworthstone/tap/ntm"
      min_version: "1.7.0"
      robot_mode: true  # use --robot-* commands exclusively
    - name: br
      purpose: "Bead task tracking"
      install: "ACFS verified installer"
    - name: agent-mail
      purpose: "Inter-agent coordination"
      type: "mcp-server"
  optional:
    - name: bv
      purpose: "Task intelligence (prefer ntm --robot-plan)"
      warning: "Never run bare bv - always use --robot-* flags"
    - name: exploring-codebase
      purpose: "Architecture discovery for Phase 0.5"
      type: "skill"

# Phase configuration
phases:
  planning:
    name: "Intake & Planning"
    human_checkpoint: true
    outputs: ["task-manifest"]
    notes: |
      Scope policy: Orchestrator enforces non-overlapping file scopes.
      This is orchestrator policy, not a guarantee from any tool output.
  
  arch_validation:
    name: "Architecture Validation"
    optional: true
    condition: "unfamiliar codebase or stale discovery docs"
  
  spawn:
    name: "Spawn & Register"
    capability_detection: true
    notes: |
      Robot mode is mandatory. Perform a non-destructive check (help text / --robot-list) before spawning.
      If robot mode is missing, escalate rather than falling back to subcommands.
  
  distribute:
    name: "Prompt Distribution"
    template_dir: "templates/"
  
  monitor:
    name: "Monitoring Loop"
    polling_strategy: "terse-as-change-detector"
    notes: |
      --robot-terse is a cheap change detector, not authoritative state.
      On change, fetch --robot-status (JSON) for authoritative data.
      Worker state JSON files are the primary progress source per pane.
      Tail output is secondary diagnostics when state files are stale/missing.
      Never parse terse format for structured data.
    min_interval_seconds: 90
    timeout_minutes: 60
  
  collect:
    name: "Results Collection"
    quality_gates_required: true
  
  synthesize:
    name: "Synthesis"
    human_checkpoint: true
  
  teardown:
    name: "Teardown"
    human_checkpoint: true

# Escalation configuration
escalation:
  always_escalate:
    - scope-ambiguity
    - priority-conflict
    - systemic-failure      # 3+ agent failures in 5 min
    - security-sensitive    # .env, secrets, auth modifications
    - timeout-approaching   # >80% elapsed, <60% complete
    - destructive-operation # delete tests, drop tables
    - quality-gate-bypass
    - manifest-uncertainty
  
  never_escalate:
    - routine-file-conflict  # Arbitrate: earlier wins
    - single-agent-crash     # Auto-restart handles
    - simple-code-questions
    - git-rebase-instructions
    - context-file-requests  # Prefer in-scope search/read; use -c only for narrow immutable refs

# Agent capabilities (for task assignment)
agent_capabilities:
  claude-code:
    alias: cc
    strengths:
      - "Complex multi-file refactoring"
      - "Architecture decisions"
      - "Nuanced code review"
      - "Agent Mail coordination"
    model_options: ["opus-4.6", "sonnet-4.5"]
    context_refresh: "/clear"
  
  codex:
    alias: cod
    strengths:
      - "Fast code generation"
      - "Test writing"
      - "Straightforward implementations"
      - "Documentation"
    context_refresh: "/new"
  
  gemini:
    alias: gmi
    strengths:
      - "Documentation review"
      - "Large context analysis"
      - "Research tasks"

  ollama:
    alias: oll
    strengths:
      - "Local inference (no API cost)"
      - "Privacy-sensitive tasks"
      - "Rapid prototyping"
    note: "Recognized as official agent type in NTM v1.7.0"

# NTM robot mode command reference
ntm_robot_commands:
  spawn: "ntm --robot-spawn=<session> --spawn-cc=N --spawn-cod=M --spawn-dir=/path"
  send_file: "ntm send <session> --pane=N --file=/path --json"
  send_message: "ntm send <session> --pane=N \"text\" --json"
  send_context: "ntm send <session> --pane=N --file=/path -c f1 -c f2 --json (rare; immutable refs only)"
  status: "ntm --robot-status"
  health: "ntm --robot-health=<session>"
  terse: "ntm --robot-terse"
  tail: "ntm --robot-tail=<session> --panes=1,2 --lines=30"
  save: "ntm save <session> -o /path/to/dir"
  plan: "ntm --robot-plan"
  kill: "ntm kill <session> --force"
  interrupt: "ntm --robot-interrupt=<session> --panes=N"
  snapshot: "ntm --robot-snapshot"
  wait: "ntm --robot-wait=<session> --wait-until=idle"
  preflight: "ntm preflight --file=/path/to/prompt.md --json"
  agent_health: "ntm --robot-agent-health=<session> --panes=N"

# Polling strategy
polling:
  strategy: "terse-as-change-detector"
  description: |
    Use --robot-terse as cheap change detection (~100 tokens).
    On change, fetch --robot-status (JSON) for authoritative state.
    This decouples the skill from terse format changes.
  
  cadence:
    - window: "0-2 min"
      interval: null
      note: "No polling - agents initializing"
    - window: "2-10 min"
      interval_seconds: 120
      primary: "--robot-terse"
      on_change: "--robot-status"
    - window: "10-30 min"
      interval_seconds: 180
      primary: "--robot-terse"
      on_change: "--robot-status, state-file check, --robot-tail on anomaly fallback"
    - window: "30+ min"
      interval_seconds: 300
      primary: "--robot-terse"
      on_change: "--robot-status, --robot-health"

# Scope policy
scope_policy:
  enforced_by: "orchestrator"
  description: |
    Non-overlapping file scopes are ORCHESTRATOR POLICY.
    Tools like bv --robot-plan provide advisory tracks, but the
    orchestrator is responsible for assigning and enforcing scopes.
    Never assume any tool guarantees non-overlap.

# Default configuration
defaults:
  agent_mix: "--spawn-cc=7 --spawn-cod=3"
  timeout_minutes: 60
  min_poll_interval_seconds: 90
  quality_gates: "bun run typecheck && bun run lint && bun run test"
  runtime_dir: "${XDG_RUNTIME_DIR:-/tmp}/ntm-orch-<uid>"
  temp_file_pattern: "<runtime>/<session>/*"
  pane_state_schema: "{task_id,status,files_modified,gates_passed,last_update_ts,blocker}"

# Capability detection
capability_detection:
  description: |
    NTM versions may vary (minimum v1.7.0). Robot mode is mandatory for this skill.
    Use a non-destructive capability check (help text contains --robot-, and/or ntm --robot-status succeeds).
  probe_command: |
    ntm --help | grep -q "--robot-" && ntm --robot-status >/dev/null

# Hooks (recommended)
hooks:
  PreToolUse:
    - hooks/pre-tool-use.js
  SubagentStop:
    - hooks/subagent-stop.js
  Stop:
    - hooks/stop.js
